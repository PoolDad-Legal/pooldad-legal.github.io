```markdown
# IONFLUX Project: Minimal Viable Shopify Integration Service Specification (v3 Proposals)

This document proposes V3 updates for the Shopify Integration Service specification, aligning it with `core_agent_blueprints_v3.md` (especially Agent 004 - Shopify Sales Sentinel), `conceptual_definition_v3.md` (`PlatformEvent` schema, Kafka integration), `saas_api_integration_specs_v3.md`, and `technical_stack_and_demo_strategy_v3.md`. The primary focus is on robust webhook handling and publishing standardized events to Kafka.

**Version Note:** This is v3 of the Shopify Integration Service minimal specification.

**Chosen Technology:** Python with FastAPI (reconfirmed as per `technical_stack_and_demo_strategy_v3.md`).

## 1. Authentication & Initial Setup

### 1.1. `GET /integrations/shopify/auth/initiate`
*   **Purpose:** Initiates the Shopify OAuth 2.0 flow.
*   **Protection:** Requires JWT.
*   **Query Parameters:** `workspace_id: uuid`, `brand_id: uuid`.
*   **Response (Success 302 - Found):** Redirects to Shopify OAuth URL.
    *   `redirect_uri` must point to `/integrations/shopify/auth/callback`.
    *   `state` token must securely encode or link to `workspace_id`, `brand_id`, `user_id`, and a CSRF token.
*   (Error responses, Brief Logic: Largely as previously defined, ensuring `state` management is robust).

### 1.2. `GET /integrations/shopify/auth/callback`
*   **Purpose:** Handles Shopify OAuth callback.
*   **Query Parameters (from Shopify):** `code`, `shop`, `state`, `hmac`.
*   **Response (Success 200 - OK or Redirect):**
    ```json
    {
      "message": "Shopify store connected successfully. Webhooks are being registered.",
      "brand_id": "uuid",
      "shopify_store_url": "string"
    }
    ```
    (Or redirect to a frontend success page).
*   **Brief Logic:**
    1.  Validate HMAC and `state` token (retrieve `workspace_id`, `brand_id`, `user_id`).
    2.  Exchange `code` for an access token with Shopify.
    3.  **Securely Store Token:** Encrypt the access token. Update the `Brand` entity (via `BrandService` call or direct DB update if this service manages `Brand.shopify_integration_details_json`) with:
        *   `shopify_integration_details_json.store_url`: `https://{shop}`
        *   `shopify_integration_details_json.access_token_secret_ref`: Reference to the securely stored encrypted token.
        *   `shopify_integration_details_json.last_sync_status`: 'connected'.
        *   `shopify_integration_details_json.last_sync_timestamp`: `NOW()`.
    4.  **Register Essential Webhooks (Critical V3 Update):**
        *   Asynchronously, after storing the token, initiate a process to register necessary webhooks with the newly connected Shopify store.
        *   **Webhook Topics:** `orders/create`, `orders/updated`, `products/update`, `themes/publish`, `app/uninstalled`, and others relevant to PRM agents (especially Agent 004). A configurable list of topics should be maintained.
        *   **Webhook URL:** For each webhook, the URL provided to Shopify must be the new ingestion endpoint (see Section 2.1), e.g., `https://<ionflux_api_domain>/integrations/shopify/webhooks/{secure_path_identifier}`. The `{secure_path_identifier}` must be a unique, unguessable token generated by IONFLUX for this specific brand's Shopify connection, allowing this service to map incoming webhooks back to the `workspace_id` and `brand_id`. This identifier should be stored alongside the brand's Shopify integration details.
    5.  Return success message/redirect.

## 2. Shopify Webhook Ingestion & Kafka Event Publishing (Core V3 Functionality)

This section is central to enabling event-driven agent behavior.

### 2.1. `POST /integrations/shopify/webhooks/{secure_path_identifier}`
*   **Purpose:** Receives incoming webhooks from Shopify for all connected stores.
*   **Path Parameter:** `secure_path_identifier` (A unique token generated per Shopify store connection during the webhook registration process. This service must maintain a mapping of these identifiers to `workspace_id` and `brand_id`).
*   **Request Headers (from Shopify):**
    *   `X-Shopify-Topic`: e.g., `orders/create`.
    *   `X-Shopify-Hmac-Sha256`: HMAC signature.
    *   `X-Shopify-Shop-Domain`: e.g., `your-store-name.myshopify.com`.
*   **Request Body:** Raw Shopify webhook payload (JSON).
*   **Response (to Shopify - Synchronous):**
    *   **Success 200 - OK:** Empty body. This must be returned quickly to Shopify.
    *   **Error 400/401/403:** If validation fails.
*   **Brief Logic:**
    1.  **Identify Source:** Look up `workspace_id` and `brand_id` using the `secure_path_identifier`. If not found, return 403/404.
    2.  **Validate Webhook:** Verify the `X-Shopify-Hmac-Sha256` signature using the Shopify shared secret associated with this brand's connection (retrieved from secure storage). If invalid, return 401.
    3.  **Acknowledge Shopify:** Immediately return 200 OK to Shopify if validation passes.
    4.  **Asynchronous Processing (Crucial):** Perform the following steps in a background task (e.g., using FastAPI's `BackgroundTasks` or by pushing to an internal short-lived queue like Redis RQ).
        a.  **Transform to `PlatformEvent`:**
            *   `event_id`: Generate new UUID.
            *   `event_type`: Construct a standardized IONFLUX event type, e.g., `ionflux.shopify.brand_{brand_id}.{shopify_topic_entity}.{action}`. Example: `ionflux.shopify.brand_abc123.orders.created`.
            *   `event_timestamp`: Use timestamp from Shopify webhook if available, otherwise `NOW()`.
            *   `source_service_name`: `"ShopifyIntegrationService"`.
            *   `workspace_id`: The identified `workspace_id`.
            *   `payload_schema_version`: e.g., `"v1.shopify.YYYY-MM"` (Shopify API version).
            *   `payload_json`: The relevant Shopify data from the webhook body. This payload should be the direct Shopify data for that event.
        b.  **Publish to Kafka:**
            *   Publish the created `PlatformEvent` object to a designated Kafka topic.
            *   **Topic Strategy:** As per `technical_stack_and_demo_strategy_v3.md`, this could be a workspace-specific topic (e.g., `ionflux.shopify.ws_{workspace_id}.events_raw` or `ionflux.shopify.ws_{workspace_id}.brand_{brand_id}.events_raw`) to allow targeted consumption by agents within that workspace. The `AgentDefinition` for agents like Sales Sentinel will specify which topics they consume.
            *   Log success or failure of Kafka publish.

## 3. API Endpoints for Data Fetching (Optional for Demo)

These are secondary for the event-driven E2E demo but might be needed for full agent functionality or initial data syncs.

### 3.1. `GET /integrations/shopify/brands/{brand_id}/shop-details`
*   **Purpose:** Internal endpoint for basic shop details.
*   **Protection:** Inter-service authentication.
*   **Response (Success 200 - OK):**
    ```json
    {
      "brand_id": "uuid",
      "shop_name": "string (Mocked Shopify Store for Demo)",
      "currency": "string (e.g., USD)"
    }
    ```
*   **Brief Logic (Demo):** Return mocked data. Production logic would use stored token to call Shopify's `/admin/api/YYYY-MM/shop.json`.

### 3.2. Other Data Fetching Endpoints (Conceptual for Future)
*   Endpoints like `/integrations/shopify/brands/{brand_id}/products` or `/orders` might be needed for agents that require historical data or perform batch operations. For the E2E demo, these are out of scope; agents will be event-driven or use very limited mocked initial data.

## 4. Secure Token & Secret Management
*   **Access Tokens:** Shopify access tokens are retrieved via OAuth, encrypted, and stored with a reference (e.g., path in secrets manager) in `Brand.shopify_integration_details_json.access_token_secret_ref`.
*   **Webhook Shared Secrets:** The Shopify shared secret (used for HMAC validation) must also be securely stored per brand connection, likely alongside the access token details.
*   **Usage:** This service decrypts tokens/secrets only when needed for API calls (e.g., registering webhooks) or validating incoming webhooks.

## 5. Database Interaction
*   Primarily interacts with the `brands` table (or `BrandService`) to retrieve/update `shopify_integration_details_json` (store URL, token secret ref, webhook secure path identifier, Shopify shared secret ref).
*   May have its own small table to map `secure_path_identifier` to `workspace_id`/`brand_id` if not stored directly in `brands` entity.

## 6. Framework & Libraries
*   (As previously defined: FastAPI, uvicorn, SQLAlchemy, asyncpg, httpx, cryptography, Kafka client like `kafka-python` or `confluent-kafka-python`).

This V3 specification for the Shopify Integration Service pivots its core responsibility towards robust webhook ingestion and standardized `PlatformEvent` publishing to Kafka, enabling the advanced event-driven capabilities of PRM agents like Shopify Sales Sentinel.
```
